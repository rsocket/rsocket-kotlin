name: Release CI

on:
  # Trigger the workflow on push
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - '*' # Push events to matching *, i.e. 1.0, 20.15.10

jobs:
  test:
    name: ${{ matrix.target }} Test Run (JVM ${{ matrix.jvm }})
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest ]
        target: [ macosX64, iosX64, tvosX64, watchosX86 ]
        jvm: [ 11 ]
        include:
          - os: windows-latest
            target: mingwX64
            jvm: 11
          - os: ubuntu-latest
            target: linuxX64
            jvm: 11
          - os: ubuntu-latest
            target: jsIrNode
            jvm: 11
          - os: ubuntu-latest
            target: jsIrBrowser
            jvm: 11
          - os: ubuntu-latest
            target: jsLegacyNode
            jvm: 11
          - os: ubuntu-latest
            target: jsLegacyBrowser
            jvm: 11
          - os: ubuntu-latest
            target: jvm
            jvm: 8
          - os: ubuntu-latest
            target: jvm
            jvm: 11
          - os: ubuntu-latest
            target: jvm
            jvm: 15
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: ${{ matrix.jvm }}
      - uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches/modules-2
            ~/.gradle/wrapper
            ~/.konan
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: ${{ runner.os }}-gradle-
      - name: Test rsocket-core module
        if: success() || failure()
        timeout-minutes: 10
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: rsocket-core:${{ matrix.target }}Test --scan --info
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false
      - name: Test rsocket-transport-local module
        if: success() || failure()
        timeout-minutes: 10
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: rsocket-transport-local:${{ matrix.target }}Test --scan --info
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false
      - name: Test rsocket-transport-ktor module
        if: matrix.target != 'mingwX64' && matrix.target != 'jsIrNode' && matrix.target != 'jsIrBrowser' && matrix.target != 'jsLegacyNode' && matrix.target != 'jsLegacyBrowser' && (success() || failure())
        timeout-minutes: 10
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: rsocket-transport-ktor:${{ matrix.target }}Test --scan --info
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false

      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@v2
        with:
          fail_on_failure: true
          check_name: ${{ matrix.target }} Test Report (JVM ${{ matrix.jvm }})
          report_paths: '**/build/test-results/*Test/TEST-*.xml'
          github_token: ${{ secrets.GITHUB_TOKEN }}

  build:
    strategy:
      matrix:
        os: [ macos-latest, ubuntu-latest, windows-latest ]
      fail-fast: false
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: 8
      - uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches/modules-2
            ~/.gradle/wrapper
            ~/.konan
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: ${{ runner.os }}-gradle-
      - name: Check full project builds
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: build -PskipTests --scan --info
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false

  publish:
    needs: [ build, test ]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
      fail-fast: false

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: 8
      - uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches/modules-2
            ~/.gradle/wrapper
            ~/.konan
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: ${{ runner.os }}-gradle-
      - name: Set TAG_NAME for publication
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        shell: bash
      - name: Publish Packages to Bintray + JCenter (version ${{ env.TAG_NAME }})
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: bintrayUpload -PbintrayUser=${{ secrets.bintrayUser }} -PbintrayKey=${{ secrets.bintrayKey }} -PsonatypeUsername=${{ secrets.sonatypeUsername }} -PsonatypePassword=${{ secrets.sonatypePassword }} -Pversion=${{ env.TAG_NAME }} -PbuildNumber=${{ github.run_number }} --info
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false
